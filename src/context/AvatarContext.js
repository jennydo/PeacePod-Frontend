import { createContext, useReducer, useState, useEffect } from 'react';
import { createAvatar } from '@dicebear/core';
import { lorelei } from '@dicebear/collection';

export const AvatarContext = createContext();

export const avatarReducer = (state, action) => {
    switch (action.type) {
        case "SET_ATTRIBUTE":
            return {
                ...state,
                avatarData: {
                ...state.avatarData,
                [action.payload.attribute]: [action.payload.value]
                }
            };
        
        case "SET_PROBABILITY":
            return {
                ...state,
                avatarData: {
                    ...state.avatarData, 
                    [action.payload.attribute]: action.payload.value
                }
            }

        case "SET_AVATAR": 
            return {
                ...state,
                avatar: action.payload
            }
        case "SET_AVATAR_DATA": 
            return {
                ...state,
                avatarData: action.payload
            }
        default:
            return state
    }
}

export const AvatarContextProvider = ( {children} ) => {
    const [state, dispatch] = useReducer(avatarReducer, {
        avatarData: {
            seed: "John Doe",
            head: ["variant01"], 
            eyes: ["variant01"], 
            eyebrows: ["variant01"],
            mouth: ["happy02"], 
            nose: ["variant01"], 
            hair: ["variant37"], 
            frecklesProbability: 0, 
            beard: ["variant01"], 
            beardProbability: 0,
            earrings: ["variant01"],
            earringsProbability: 0,
            glasses: ["variant01"],
            glassesProbability: 0,
            hairAccessories: ["flowers"],
            hairAccessoriesProbability: 0,
            backgroundColor: ["c0aede"],
            backgroundType: ["solid"],
            scale: 100,
            size: 200
        },
        // avatar: "data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20980%20980%22%20fill%3D%22none%22%20shape-rendering%3D%22auto%22%20width%3D%22200%22%20height%3D%22200%22%3E%3Cmetadata%20xmlns%3Ardf%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2F02%2F22-rdf-syntax-ns%23%22%20xmlns%3Axsi%3D%22http%3A%2F%2Fwww.w3.org%2F2001%2FXMLSchema-instance%22%20xmlns%3Adc%3D%22http%3A%2F%2Fpurl.org%2Fdc%2Felements%2F1.1%2F%22%20xmlns%3Adcterms%3D%22http%3A%2F%2Fpurl.org%2Fdc%2Fterms%2F%22%3E%3Crdf%3ARDF%3E%3Crdf%3ADescription%3E%3Cdc%3Atitle%3ELorelei%3C%2Fdc%3Atitle%3E%3Cdc%3Acreator%3ELisa%20Wischofsky%3C%2Fdc%3Acreator%3E%3Cdc%3Asource%20xsi%3Atype%3D%22dcterms%3AURI%22%3Ehttps%3A%2F%2Fwww.figma.com%2Fcommunity%2Ffile%2F1198749693280469639%3C%2Fdc%3Asource%3E%3Cdcterms%3Alicense%20xsi%3Atype%3D%22dcterms%3AURI%22%3Ehttps%3A%2F%2Fcreativecommons.org%2Fpublicdomain%2Fzero%2F1.0%2F%3C%2Fdcterms%3Alicense%3E%3Cdc%3Arights%3ERemix%20of%20%E2%80%9ELorelei%E2%80%9D%20(https%3A%2F%2Fwww.figma.com%2Fcommunity%2Ffile%2F1198749693280469639)%20by%20%E2%80%9ELisa%20Wischofsky%E2%80%9D%2C%20licensed%20under%20%E2%80%9ECC0%201.0%E2%80%9D%20(https%3A%2F%2Fcreativecommons.org%2Fpublicdomain%2Fzero%2F1.0%2F)%3C%2Fdc%3Arights%3E%3C%2Frdf%3ADescription%3E%3C%2Frdf%3ARDF%3E%3C%2Fmetadata%3E%3Cmask%20id%3D%22viewboxMask%22%3E%3Crect%20width%3D%22980%22%20height%3D%22980%22%20rx%3D%220%22%20ry%3D%220%22%20x%3D%220%22%20y%3D%220%22%20fill%3D%22%23fff%22%20%2F%3E%3C%2Fmask%3E%3Cg%20mask%3D%22url(%23viewboxMask)%22%3E%3Crect%20fill%3D%22%23c0aede%22%20width%3D%22980%22%20height%3D%22980%22%20x%3D%220%22%20y%3D%220%22%20%2F%3E%3Cg%20transform%3D%22translate(10%20-60)%22%3E%3Cpath%20fill-rule%3D%22evenodd%22%20clip-rule%3D%22evenodd%22%20d%3D%22m448%20193%2015%202%209%202c9%201%2017%203%2025%207%208-4%2018-6%2027-7a148%20148%200%200%201%2077%2014%20125%20125%200%200%201%2045%2033l19%204c11%204%2022%209%2032%2016%2010%209%2018%2020%2024%2032l6%2017%201%204v2a232%20232%200%200%200%2034%2070c7%2010%2014%2021%2019%2032%206%2012%2011%2025%209%2039-1%2013-6%2025-16%2034l-3%2015c-4%2011-10%2023-20%2031%203%206%206%2012%207%2019%202%2015%200%2031-7%2045-2%203-4%204-7%205l-1-8-1-5c-2-14-11-27-21-37a47%2047%200%200%201-9%2045c-7%209-18%2016-28%2022-5%202-10%204-15%202l-2-3c-1-2-3-3-3-5-2-7-2-15-2-23v-6c0-16%202-31%204-47-10-4-18-12-24-21-9-12-12-26-13-41-2-30%206-60%2025-84l-6-5-4-4c-18-15-26-35-32-57-3-12-4-26%200-37-4%200-9-1-10-5-1-7%203-14%207-19l-13%207-5%202-10%206c-6%203-12%207-19%209-2%201-4-1-6-2l-5-3c-13-9-26-17-40-23%203%204%206%209%206%2014-1%203-1%206-4%207l-13-1-5-1h-28c-8%2019-12%2038-16%2058a532%20532%200%200%201-29%2091c-8%2017-19%2032-32%2046-8%208-16%2014-25%2020%2018%2011%2030%2028%2039%2046%2017%2033%2029%2068%2031%20105%201%2019-3%2038-11%2055-5%2013-16%2024-29%2030-8%204-18%205-27%205-8-1-15-4-21-8a76%2076%200%200%200-40%207l-1%201c-4%203-8%205-11%2010-5%206-8%2013-10%2021v1c0%202%200%203-2%203-3-5-4-11-4-17%200-9%205-17%209-25l12-11c-5-2-10-5-14-9a69%2069%200%200%201-22-38c-5%201-10%202-15%201-16-1-31-8-42-19-6-6-12-14-16-22l-3-3-2-1-14-17c-9-15-14-33-13-51s6-36%2016-51l11-11c-7-13-12-28-12-43v-12a101%20101%200%200%201%2027-123c10-9%2022-17%2035-18%2014-22%2030-43%2049-60a235%20235%200%200%201%2096-49c22-6%2044-7%2067-5Zm224%2072c13%207%2025%2016%2032%2029%205%2011%207%2022%2010%2033l5%2020a175%20175%200%200%200%2027%2050c8%2012%2016%2024%2022%2036%204%2010%206%2021%204%2032l-7-22c-6-15-14-27-22-41l-1-2-9-12-1-1-6-10-7-10-1-6-1-2a168%20168%200%200%200-45-94Zm-224%2046%2010-25c-14%201-27%203-41%206-8%2015-15%2029-20%2046-6%2023-7%2047-9%2070v6c-1%2018-3%2036-8%2053a201%20201%200%200%200%2047-86l10-32%2010-36%201-2Zm-218%207-11%2029v1l-1%203c-18%2018-31%2044-38%2069a90%2090%200%200%201%2027-86c7-6%2015-12%2023-16Zm-52%20220c3-10%208-19%2015-27l-9%209a88%2088%200%200%200-6%2084l-3-27c-1-13-1-26%203-39Z%22%20fill%3D%22%23000000%22%2F%3E%3Cpath%20d%3D%22M528%20244c41%206%2080%2022%20113%2047%2028%2021%2050%2049%2065%2081%2013%2028%2020%2060%2019%2091-1%2015-3%2030-8%2044h-2l1-21c1-30-2-59-13-87-10-30-28-57-50-79-42-40-98-62-156-63a243%20243%200%200%200-196%2094%20207%20207%200%200%200-40%20139l2%2025c8%200%2019%200%2025%207l-3%203-17%201c-12%201-24%205-33%2013a64%2064%200%200%200-17%2039c-5%2032%2012%2065%2039%2083%2016%2010%2036%2015%2055%209%204-2%209-5%2014-3%203%201%204%204%205%207a251%20251%200%200%200%2090%20100c8%207%2018%2013%2028%2018%2018%208%2038%2014%2057%2019l32%208c5%201%209%201%2013%203l-4%201c-25%202-48-3-72-10-12-3-23-7-34-12a306%20306%200%200%201-84-63l2%2028c1%2017%200%2035-6%2052-4%2012-11%2024-19%2034-10%2010-22%2019-34%2026-10%207-21%2014-32%2018l-16%205%209-9%2031-20%2022-17a95%2095%200%200%200%2032-56c2-14%202-28%202-43v-27c-10-14-22-29-27-46-17%208-38%207-55-1-17-7-32-19-43-33-12-17-19-36-21-56s2-40%2015-56c9-10%2022-18%2035-21-4-14-6-29-6-44a234%20234%200%200%201%2083-173%20249%20249%200%200%201%20199-55Z%22%20fill%3D%22%23000%22%2F%3E%3Cpath%20d%3D%22M653%20320c22%2022%2040%2049%2050%2079%2011%2028%2014%2057%2013%2087l-1%2021-5%2015-2%2013%202%2056c0%2021%201%2042-1%2063l-3%2047c-2%2016-7%2031-14%2045-11%2018-26%2033-44%2044-13%208-27%2012-41%2016l-38%2011-17%203c0%201%201%202%203%202%208%205%2017%205%2026%204-3%207-4%2014-2%2022%203%207%2011%2011%2017%2014%2012%206%2024%207%2036%209%207%206%2014%2014%2016%2024%202%208%202%2016-2%2023-5%2010-14%2018-24%2023-13%208-27%2014-42%2018a468%20468%200%200%201-222-1c-17-4-33-9-48-17-12-6-23-13-32-22-5-7-9-14-10-23%2011-4%2022-11%2032-18%2012-7%2024-16%2034-26%208-10%2015-22%2019-34%206-17%207-35%206-52l-2-28%2022%2023c19%2015%2040%2030%2062%2040%2011%205%2022%209%2034%2012%2024%207%2047%2012%2072%2010l4-1c-4-2-8-2-13-3l-32-8c-19-5-39-11-57-19l-29-17c-11-9-23-17-33-27a251%20251%200%200%201-56-74c-1-3-2-6-5-7-5-2-10%201-14%203-19%206-39%201-55-9a88%2088%200%200%201-39-83c1-14%207-28%2017-39%209-8%2021-12%2033-13l17-1%203-3c-6-7-17-7-25-7l-2-25a207%20207%200%200%201%2040-139%20243%20243%200%200%201%20196-94c58%201%20114%2023%20156%2063Z%22%20fill%3D%22%23ffffff%22%2F%3E%3Cpath%20d%3D%22M710%20522c3%200%203%204%204%206%203%2011%204%2023%205%2034l2%2021c1%2022%202%2043%201%2065-1%2021-1%2044-5%2065a136%20136%200%200%201-80%2099c-15%207-31%2011-48%2013v15c1%203%203%204%205%206%2012%206%2023%208%2036%2011%2012%203%2024%205%2036%2011-3%203-7%204-11%204-7%201-15-1-23-1-12-2-24-3-36-9-6-3-14-7-17-14-2-8-1-15%202-22-9%201-18%201-26-4-2%200-3-1-3-2l17-3%2038-11c14-4%2028-8%2041-16%2018-11%2033-26%2044-44%207-14%2012-29%2014-45l3-47c2-21%201-42%201-63l-2-56%202-13ZM252%20549c8%200%2017%201%2023%207%205%204%2010%209%2012%2015%201%203%200%206-2%208l-13%208c-7%206-7%2019%200%2025%206%205%2014%208%2021%2011%202%200%205%201%206%203-1%202-3%203-5%203-10%200-20-3-28-9-5-3-8-8-9-13-2-8-2-17%204-24%204-6%2011-9%2018-12-4-5-7-11-14-13-7-3-15-3-22-5l9-4Z%22%20fill%3D%22%23000%22%2F%3E%3Cpath%20d%3D%22m693%20510-2%207c-3%205-6%209-11%2012s-11%204-17%205l-18%202c-5%200-8%203-10%206l-7%207c-2%201-5-1-4-3%201-8%207-14%2011-20%203-3%207-7%2012-7l30-5c5-1%2010-4%2016-4ZM388%20514c12-1%2021%203%2032%204%2015%202%2030%204%2045%204l24%202c8%201%2017%200%2024%204s12%2010%2016%2016c1%202%202%204%200%207-1%201-3%200-4-1-4-2-7-6-11-7l-12-1-28-1-22-1c-10-1-20-1-30-5-7-2-12-6-19-9l-12-9c-2-1-3-1-3-3Z%22%20fill%3D%22%23000000%22%2F%3E%3Cpath%20d%3D%22M533%20358c6%202%209%208%2010%2014%200%208-3%2016-7%2022-3%203-7%204-10%201-4-3-2-10-2-15l-13%2010c-6%204-13%207-20%209-9%204-19%205-30%208l-25%208c-8%203-15%208-22%2012l-25%2017c-5%203-8%207-11%2012-2-4-1-8%201-11a401%20401%200%200%201%2035-29c16-13%2036-21%2055-28l28-11c8-4%2014-11%2021-16%205-2%2010-4%2015-3ZM626%20376l6%207c17%207%2033%207%2049%2016%204%202%207%206%209%2010s1%208-2%2012l-16-6c-12-6-24-7-36-11-7-3-14-4-19-10-4%208-4%2017-8%2026-1%201-1%204-4%203l-1-8%202-11c1-8%204-16%207-23%202-6%208-8%2013-5Z%22%20fill%3D%22%23000000%22%2F%3E%3Cpath%20d%3D%22M597%20505h1l3%2015%203%2026%208%2013%206%2012c2%205%202%2010%205%2014%203%205%205%2010%205%2016%200%209-6%2017-14%2020l-19%208c-5%203-9%205-15%205-5%200-11%200-13-5-2-2%200-4%202-5l12-3%2016-5%2013-5c6-2%209-8%207-14l-5-8-7-17-7-19c-4-8-6-17-5-26%200-7%201-15%204-22Z%22%20fill%3D%22%23000000%22%2F%3E%3Cpath%20d%3D%22M476%20660c3%200%205%202%207%204l13%207c11%205%2023%208%2034%2011%2015%205%2030%206%2045%206%2012%201%2023%202%2034%201l4%202c-18%209-41%2011-61%2010-23-1-46-8-66-18-6-4-13-8-14-16-1-3%201-7%204-7Z%22%20fill%3D%22%23000000%22%2F%3E%3Cpath%20fill-rule%3D%22evenodd%22%20clip-rule%3D%22evenodd%22%20d%3D%22M468%20196a218%20218%200%200%200-234%20122%20323%20323%200%200%200-25%20186l4%2019c1%203%203%206%205%206l4%201h1c5%206%2012%2010%2020%2012%2012%204%2026%204%2038%202-3%2016%201%2034%207%2049%205%2012%2013%2025%2023%2034a67%2067%200%200%200%2051%2014c5-1%209-4%2013-8v-1l2-5h-3c-3%200-5%200-8-2-11-6-19-17-25-28-10-20-15-43-15-65%2013-6%2024-16%2033-27l7-5%204-2c9-6%2017-14%2025-22%2017-20%2030-43%2039-67a443%20443%200%200%200%2016-63c4-20%208-41%2017-60a185%20185%200%200%201%2034%201l12%201c3-1%204-4%204-7%200-5-3-10-6-14a272%20272%200%200%201%2045%2026c2%202%205%203%207%202a172%20172%200%200%200%2026-13l6-4%2014-7c-3%205-7%2012-7%2018%200%203%203%205%206%205%2011%201%2021-1%2032-4l4-1c4-1%208%202%2011%204%209%209%2015%2022%2016%2034a118%20118%200%200%201%200%2035l-1%2011-1%2015-2%2037c2%2016%208%2032%2020%2043%209%209%2022%2012%2034%209%206-2%2012-6%2016-10%205-4%207-9%207-16l-11%204-14%204v-8c4-3%208-7%2010-11l-2-9-1-7-3-23-3-25-1-7c-2-14-4-27-9-41a162%20162%200%200%200-42-68c-6-4-11-7-18-9a136%20136%200%200%200-39-36c-17-8-34-14-52-17-15-2-32-3-46%201l-16%205c-9-4-19-6-29-8Zm-20%20115c3-8%205-17%2010-25-14%201-27%203-41%206-7%2013-14%2027-18%2041a232%20232%200%200%200-10%2071c-2%2021-3%2043-9%2063%2019-20%2034-45%2042-71%206-15%2010-30%2014-46%204-13%207-26%2012-38v-1Z%22%20fill%3D%22%23000000%22%2F%3E%3C%2Fg%3E%3Cg%20transform%3D%22translate(10%20-60)%22%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E"
        avatar: ""
    })

    useEffect(() => {
        const generateAvatar = async () => {  
            await createAvatar(lorelei, state.avatarData).toDataUri()
            .then(promise => 
                {
                    dispatch({ type: "SET_AVATAR", payload: promise });
                    // console.log(promise)
                }
            ).catch(error => console.log(error))
        }
        generateAvatar();
    }, [state.avatarData]);

    useEffect(()=> {
        const user = JSON.parse(localStorage.getItem('user'))
        if (user) {
            dispatch({
                type: "SET_AVATAR", 
                payload: user.user.avatar
            })
            dispatch({
                type: "SET_AVATAR_DATA", 
                payload: user.user.avatarData
            })
        }
    }, [])
    
    // console.log("AvatarContext stata: ", state)

    return (
        <AvatarContext.Provider value={ {...state, dispatch} }>
            {children}
        </AvatarContext.Provider>
    )
}